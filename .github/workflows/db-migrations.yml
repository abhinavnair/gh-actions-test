name: DB Migrations
concurrency: PRODUCTION
on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to run migrations on'
        required: true
        type: environment
      service:
        description: 'Service to run migrations on'
        required: true
        type: choice
        options:
          - ledgersvc
      database:
        description: 'Which database?'
        required: true
        type: string
      direction:
        description: 'Direction of migration (up/down)'
        required: true
        type: choice
        options:
          - up
          - down
jobs:
  prepare:
    name: Prepare # Using separate job to be able to print before the approval stage triggered by the `environment` setting
    runs-on: ubuntu-latest
    steps:
      - name: Print Inputs
        run: echo "${{ toJSON(inputs) }}"
      - name: Check
        if: ${{ !startsWith(github.ref, 'refs/tags/v') && github.ref != 'refs/heads/main' }}
        run: |
          { echo "Wrong branch/tag"; } 2>
          /dev/null && exit 1
  run-migrations:
    name: Test golib
    depends: [prepare]
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    steps:
      - name: Run
        run: echo Running...
